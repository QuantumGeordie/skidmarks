<script type="text/javascript">
  var tl;
  function onLoad() {
    SimileAjax.History.enabled = false;

    var eventSource = new Timeline.DefaultEventSource();
    var zones = [
        {   start:    "<%= @start_time %>",
            end:      "<%= @end_time %>",
            magnify:  10,
            unit:     Timeline.DateTime.MINUTE,
            multiple: 10
        }
    ];

    var theme = Timeline.ClassicTheme.create(); // create the theme
        theme.timeline_start = new Date(Date.parse("<%= @start_time %>"));
        theme.timeline_stop  = new Date(Date.parse("<%= @end_time %>"));

    var bandInfos = [
        Timeline.createBandInfo({
            eventSource:    eventSource,
            timeZone:       0,
            date:           "<%= @start_time %>",
            width:          "80%",
            theme:          theme, // Apply the theme
            intervalUnit:   Timeline.DateTime.HOUR,
            intervalPixels: 600
        }),
        Timeline.createBandInfo({
            eventSource:    eventSource,
            timeZone:       0,
            date:           "<%= @start_time %>",
            width:          "20%",
            intervalUnit:   Timeline.DateTime.DAY,
            intervalPixels: 600,
            layout:         'overview'
        })
    ];

    bandInfos[1].syncWith = 0;
    bandInfos[1].highlight = true;

    tl = Timeline.create(document.getElementById("my_timeline"), bandInfos);
    eventSource.loadJSON(<%= "#{@jobs}".html_safe %>, document.location.href);

  }

  var resizeTimerID = null;
  function onResize() {
      if (resizeTimerID == null) {
          resizeTimerID = window.setTimeout(function() {
              resizeTimerID = null;
              tl.layout();
          }, 500);
      }
  }

</script>


<%
  events_hash = JSON.parse(@jobs)

  jobs = {}

  events_hash['events'].each do |event|
    cron = event['cron'] ? event['cron'] : '--'
    jobs[event['description']] = {:cron => cron, :events => 0} unless jobs.include?(event['description'])
    jobs[event['description']][:events] += 1
  end
%>

<h2>Scheduled Jobs</h2>
<div id='my_timeline' class='skid--timeline'>
</div>
<table class='skid'>
  <thead>
  	<tr>
      <th scope='col' class='skid'>name</th>
      <th scope='col' class='skid'>cron</th>
      <th scope='col' class='skid'>events</th>
    </tr>
  </thead>
  <tbody>
    <% jobs.each do |k, v| %>
      <tr>
        <td><%= k %></td>
        <td><%= v[:cron] %></td>
        <td><%= v[:events] %></td>
      </tr>
    <% end -%>
  </tbody>
</table>
